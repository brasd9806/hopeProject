<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="donate">

	<select id="donateList" resultType="donate">
		SELECT
		B.DONATE_NO d,
		B.DONATE_TITLE,
		CASE
		WHEN TRUNC(SYSDATE) =
		TRUNC(B.DONATE_END_DATE) THEN 'D-DAY'
		WHEN TRUNC(SYSDATE) <![CDATA[ < ]]>
		TRUNC(B.DONATE_END_DATE) THEN 'D-' || (TRUNC(B.DONATE_END_DATE) -
		TRUNC(SYSDATE)) || ' 남았어요'
		ELSE 'D+' || (TRUNC(SYSDATE) -
		TRUNC(B.DONATE_END_DATE)) || ' 지났어요'
		END AS dDay,
		B.DONATE_FOUNDATION,
		NVL((SELECT
		SUM(I.DONATE_AMOUNT) FROM DONATE_INFO I WHERE I.DONATE_NO =
		B.DONATE_NO ) , 0) DONATE_AMOUNT ,
		ROUND(NVL((SELECT
		SUM(I.DONATE_AMOUNT) FROM DONATE_INFO I WHERE I.DONATE_NO =
		B.DONATE_NO ) , 0)/B.DONATE_HOPE*100) donateProgress
		FROM
		(SELECT *
		FROM
		DONATE_BOARD
		ORDER BY DONATE_NO DESC) B
	</select>

	<select id="donateDetail" resultType="donate">
		SELECT B.DONATE_NO donateNo,
		B.DONATE_TITLE donateTitle,
		NVL((SELECT
		SUM(I.DONATE_AMOUNT) FROM DONATE_INFO I WHERE I.DONATE_NO =
		B.DONATE_NO ), 0) AS donateAmount,
		B.DONATE_HOPE AS donateHope,
		ROUND(NVL((SELECT SUM(I.DONATE_AMOUNT) FROM DONATE_INFO I WHERE
		I.DONATE_NO =
		B.DONATE_NO ), 0) / B.DONATE_HOPE * 100) AS
		donateProgress,
		(SELECT COUNT(USER_NO) FROM DONATE_INFO WHERE DONATE_NO
		= B.DONATE_NO) AS
		userCount,
		CASE
		WHEN TRUNC(SYSDATE) =
		TRUNC(B.DONATE_END_DATE) THEN 'D-DAY'
		WHEN TRUNC(SYSDATE) <![CDATA[ < ]]>
		TRUNC(B.DONATE_END_DATE) THEN 'D-' ||
		(TRUNC(B.DONATE_END_DATE) -
		TRUNC(SYSDATE))
		ELSE 'D+' || (TRUNC(SYSDATE) -
		TRUNC(B.DONATE_END_DATE))
		END AS dDay,
		B.DONATE_CONTENT AS donateContent,
		B.DONATE_END_DATE
		FROM DONATE_BOARD B
		WHERE B.DONATE_NO = #{donateNo}
	</select>

	<resultMap type="currentUser" id="currentUserResultMap">
		<id property="rowNum" column="ROWNUM" />
		<result property="donateAmount" column="DONATE_AMOUNT" />
		<result property="optionalText" column="OPTIONAL_TEXT" />
		<result property="donateDate" column="DONATE_DATE" />
	</resultMap>

	<select id="selectCurrentUser" resultMap="currentUserResultMap">
		SELECT ROWNUM, i.DONATE_AMOUNT, i.OPTIONAL_TEXT, 
		TO_CHAR(i.DONATE_DATE, 'YYYY"년" MM"월" DD"일"') as "DONATE_DATE"
		FROM DONATE_BOARD D
		LEFT JOIN DONATE_INFO I ON D.DONATE_NO = I.DONATE_NO
		WHERE I.DONATE_NO = #{donateNo}
		ORDER BY I.USER_NO DESC
	</select>

</mapper>