<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="donate">

	<!-- 게시글 목록 -->
	<select id="donateList" parameterType="hashmap" resultType="donate">
		SELECT SUM_DONATE, 
		       DONATE_HOPE, 
		       DONATE_NO, 
		       DONATE_TITLE, 
		       SUM_DONATE / DONATE_HOPE * 100 AS ACH_RATE, 
		       TAG_ID, 
		       DONATE_FOUNDATION, 
		       CEIL(ABS(TRUNC(DONATE_END_DATE) - TRUNC(DONATE_START_DATE))) AS CEIL_DAY_DIFF,
		       DONATE_CREATE_DATE, COUNT, DONATE_END_DATE
		FROM (
		    SELECT SUM(DONATE_AMOUNT) AS SUM_DONATE, 
		           d.DONATE_HOPE , 
		           d.DONATE_NO, 
		           d.DONATE_TITLE, 
		           d.TAG_ID, 
		           d.DONATE_FOUNDATION, 
		           DONATE_END_DATE, 
		           DONATE_START_DATE,
		           d.DONATE_CREATE_DATE, d.COUNT
		    FROM DONATE_BOARD d
		    LEFT JOIN DONATE_INFO i ON d.DONATE_NO = i.DONATE_NO
		    WHERE STATUS = 'Y' 
		    <if test="keyword != null and keyword != ''">  
		    	AND
			    <choose>
				    <when test="condition.equals('title')">
						DONATE_TITLE LIKE '%${keyword}%'
					</when>
					<when test="condition.equals('foundation')">
						DONATE_FOUNDATION LIKE '%' || #{keyword} || '%'
					</when>
				</choose>
			</if>
		    GROUP BY d.DONATE_HOPE, d.DONATE_NO, d.DONATE_TITLE, d.TAG_ID, d.DONATE_FOUNDATION, DONATE_END_DATE, DONATE_START_DATE, d.DONATE_CREATE_DATE, d.COUNT
		)
		ORDER BY DONATE_CREATE_DATE DESC
	</select>
	
	<!-- 게시글 상세보기 -->
	<select id="donateDetail" resultType="donate">
		SELECT 
		    SUM_DONATE, 
		    DONATE_HOPE, 
		    DONATE_NO, 
		    DONATE_TITLE, 
		    ACH_RATE, 
		    DONATE_FOUNDATION, 
		    CEIL_DAY_DIFF, 
		    DONATE_CREATE_DATE, 
		    COUNT, 
		    DONATE_CONTENT, 
		    DONATE_START_DATE, 
		    DONATE_END_DATE, 
		    TOTAL_COUNT,
		    TAG_NAME
		FROM (
		    SELECT 
		        SUM(DONATE_AMOUNT) AS SUM_DONATE, 
		        d.DONATE_HOPE, 
		        d.DONATE_NO, 
		        d.DONATE_TITLE,  
		        d.DONATE_FOUNDATION, 
		        DONATE_END_DATE, 
		        DONATE_START_DATE,
		        d.TAG_ID,
		        d.DONATE_CREATE_DATE, 
		        d.COUNT, 
		        d.DONATE_CONTENT, 
		        COUNT(*) AS TOTAL_COUNT,
		        ABS(TRUNC(DONATE_END_DATE) - TRUNC(DONATE_START_DATE)) AS CEIL_DAY_DIFF,
		        SUM(DONATE_AMOUNT) / d.DONATE_HOPE * 100 AS ACH_RATE,
		        t.TAG_NAME
		    FROM 
		        DONATE_BOARD d
		    LEFT JOIN 
		        DONATE_INFO i ON d.DONATE_NO = i.DONATE_NO
		    LEFT JOIN 
		        DONATE_TAG t ON d.TAG_ID = t.TAG_ID
		    WHERE 
		        STATUS = 'Y' AND 
		        d.DONATE_NO = #{donateNo}
		    GROUP BY 
		        d.DONATE_HOPE, 
		        d.DONATE_NO, 
		        d.DONATE_TITLE, 
		        d.TAG_ID, 
		        d.DONATE_FOUNDATION, 
		        DONATE_END_DATE, 
		        DONATE_START_DATE, 
		        d.DONATE_CREATE_DATE, 
		        d.COUNT, 
		        d.DONATE_CONTENT, 
		        t.TAG_NAME
		)
	</select>
	
	<!-- 후원 현황 -->
	<select id="selectPayPeople" resultType="paymentInfo">
		SELECT i.*, USER_NAME
		FROM DONATE_INFO i
		LEFT JOIN DONATE_BOARD b ON i.DONATE_NO = b.DONATE_NO
		JOIN USERS u ON i.USER_NO = u.USER_NO
		WHERE b.STATUS = 'Y' AND i.DONATE_NO = #{donateNo}
	</select>
	
	<!-- 조회수 증가 -->
	<update id="increaseCount">
		UPDATE DONATE_BOARD
		   SET COUNT = COUNT + 1
		 WHERE DONATE_NO = #{donateNo}
	</update>
	
	<!-- 후원 다른게시글 리스트 -->
	<select id="selectOtherDonateList" parameterType="hashmap" resultType="donate">
		SELECT * 
		FROM (
		    SELECT *
		    FROM DONATE_BOARD
		    WHERE STATUS='Y'
		    ORDER BY DBMS_RANDOM.RANDOM()
		)
		WHERE ROWNUM &lt;= 6 AND SYSDATE &lt;= DONATE_END_DATE
	</select>



<!-- 	<resultMap type="currentUser" id="currentUserResultMap"> -->
<!-- 		<id property="rowNum" column="ROWNUM" /> -->
<!-- 		<result property="donateAmount" column="DONATE_AMOUNT" /> -->
<!-- 		<result property="optionalText" column="OPTIONAL_TEXT" /> -->
<!-- 		<result property="donateDate" column="DONATE_DATE" /> -->
<!-- 	</resultMap> -->

<!-- 	<select id="selectCurrentUser" resultMap="currentUserResultMap"> -->
<!-- 		SELECT ROWNUM, -->
<!-- 		i.DONATE_AMOUNT, i.OPTIONAL_TEXT, -->
<!-- 		TO_CHAR(i.DONATE_DATE, 'YYYY"년" MM"월" DD"일"') as "DONATE_DATE" -->
<!-- 		FROM DONATE_BOARD D -->
<!-- 		LEFT JOIN -->
<!-- 		DONATE_INFO I ON D.DONATE_NO = I.DONATE_NO -->
<!-- 		WHERE I.DONATE_NO = -->
<!-- 		#{donateNo} -->
<!-- 		ORDER BY I.USER_NO DESC -->
<!-- 	</select> -->

<!-- 	<select id="getPayment" resultType="paymentInfo"> -->
<!-- 		select U.USER_NAME, U.PHONE, -->
<!-- 		U.EMAIL, B.DONATE_TITLE -->
<!-- 		FROM USERS U -->
<!-- 		JOIN DONATE_INFO I ON -->
<!-- 		(I.USER_NO=U.USER_NO) -->
<!-- 		JOIN DONATE_BOARD B ON (B.DONATE_NO = I.DONATE_NO) -->
<!-- 		WHERE U.USER_NO = '2' -->
<!-- 		AND I.DONATE_NO = #{donateNo} -->
<!-- 	</select> -->

<!-- 	<insert id="save"> -->
<!-- 		insert into donate_info -->
<!-- 		(PAY_NO, DONATE_AMOUNT, PAY_TYPE, USER_NO, OPTIONAL_TEXT, DONATE_NO, -->
<!-- 		DONATE_DATE) -->
<!-- 		VALUES(SEQ_DOINFONO.NEXTVAL, #{donateAmount}, 'C', '2', #{optionalText}, #{donateNo}, SYSDATE) -->

<!-- 	</insert> -->
</mapper>